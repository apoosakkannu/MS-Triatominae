---
title: "alphadiversity_analyses"
author: "Anbu Poosakkannu"
date: "3/5/2020"
output: html_document
---

```{r setup, include=FALSE}

#load the required libraries for the analyses

library(phyloseq); packageVersion("phyloseq") #need for ordination analyses
library(ggplot2); packageVersion("ggplot2") #need for plotting graphs





```

```{r}
#Read the OTU file
abund_table<-read.csv("otu_decontam_abund.csv",row.names=1,check.names=FALSE)

#transpose the OTU abundance data to have sample names on rows
abund_table<-t(abund_table)

#Read in the complete meta data file
meta_table<-read.csv("MapAndReadsUpdated2019.csv",row.names=1,check.names=FALSE)

#Read the taxonomy
OTU_taxonomy<-read.csv("otu_decontam_taxa.csv",row.names=1,check.names=FALSE)


colnames(meta_table)<-c("ReadCount", "Plate", "WellPosition", "Organism", "State",
                        "Tcruzi","Host_Taxa", "Instar", "Instar_range", "Sex", "Locality",
                        "Nest", "Latitude", "Longitude", "Sample")




```

```{r}
###  1.1 - Phyloseq adaptation + cleanup
#Convert the data to phyloseq format
OTU = otu_table(as.matrix(abund_table), taxa_are_rows = FALSE)
TAX = tax_table(as.matrix(OTU_taxonomy))
SAM = sample_data(meta_table)
physeq<-merge_phyloseq(phyloseq(OTU, TAX),SAM,OTU_tree,OTU_seqs)

clean_data<-physeq
#column names of taxonomy file
colnames(tax_table(clean_data))




```


```{r}
#Subset field samples:
# Just nest samples
clean_nest <- clean_data %>% subset_samples(!is.na(Host_Taxa) & 
                                              !is.na(T_cruzi) & 
                                              Organism == "Triatoma" & Nest != "houseIO" &
                                              Nest != "bob" & Nest != "LVH" & Origin == "field" &
                                              T_cruzi == "N") %>% prune_taxa(taxa_sums(.) > 0, .)
clean_nest






```



```{r}
###### Removing low abundance OTUs
# melt to long format (for ggploting) 
# prune out low abundance genera
nest_genus <- clean_nest %>%
  tax_glom(taxrank = "Genus") %>%                      # agglomerate at genus level
  transform_sample_counts(function(x) {x/sum(x)} ) %>% # Transform to rel. abundance
  psmelt() %>%                                         # Melt to long format
  filter(Abundance > 0.01) %>%                          # Filter out low abundance taxa
  arrange(Sample)                                      # Arrange alphabetically by sample

# Rarefy reads to even out the depth
nest_rarefy <- rarefy_even_depth(clean_nest, sample.size = 1000)
nest_rarefy

# Create some new subsets for later use here:
rubida_rarefy <- nest_rarefy %>% subset_samples(Host_Taxa == "Trubida")
chaparral <- nest_rarefy %>% subset_samples(Locality == "Chaparral")
tucson <- rubida_rarefy %>% subset_samples(Locality == "UADS" | Locality == "LCNCA")
young <- nest_rarefy %>% subset_samples(Instar == "L1"|Instar == "L2"|Instar == "L3")




```


```{r setup, include=FALSE}
################ SECTION 2 - Diversity analyses with PERMANOVA graph plotting ###################
library(devtools)
library(adespatial)
library(microbiomeSeq) #Install 'WGCNA' manually from computer if regular installation doesn't work

### Species-specific ontogeny
Rubida <- clean_data %>% subset_samples(Host_Taxa == "Trubida")
r1 <-plot_anova_diversity(Rubida, method = c("richness", "shannon"), 
                          grouping_column = "Instar", pValueCutoff = 0.05)
print(r1)

protracta <- clean_data %>% subset_samples(Host_Taxa == "Tprotracta")
r2 <- plot_anova_diversity(protracta, method = c("richness", "shannon"), 
                           grouping_column = "Instar", pValueCutoff = 0.05)
print(r2)

gerst <- clean_data %>%  subset_samples(Host_Taxa == "Tgerstaeckeri")
r3 <- plot_anova_diversity(gerst, method = c("richness", "shannon"), 
                           grouping_column = "Instar", pValueCutoff = 0.05)
print(r3)

lect <- clean_data %>% subset_samples(Host_Taxa == "Tlecticularia")
r4 <- plot_anova_diversity(lect, method = c("richness", "shannon"),
                           grouping_column = "Instar", pValueCutoff = 0.05)
print(r4)

sang <- clean_data %>% subset_samples(Host_Taxa == "Tsanguisuga")
r5 <- plot_anova_diversity(sang, method = c("richness", "shannon"),
                           grouping_column = "Instar", pValueCutoff = 0.1)
print(r5)





```
